{
  "env": {
    "UV_PYTHON":               "$PWD/.venv/bin/python",
    "DEVBOX_COREPACK_ENABLED": "1",
    "PGHOST":                  "localhost"
  },
  "packages": [
    "python@3.13",
    "nodejs@latest",
    "uv@latest",
    "duckdb@latest",
    "podman@latest",
    "podman-compose@latest",
    "postgresql@latest",
    "sqlcmd@latest",
    "bat@latest",
    "sqlfluff@latest"
  ],
  "shell": {
    "init_hook": [
      "unset DEBUGINFOD_URLS",
      ". $VENV_DIR/bin/activate > /dev/null 2>&1",
      "uv pip install -r requirements.txt > /dev/null 2>&1",

      "# --- Podman-machine (macOS only) ---",
      "if [ \"$(uname)\" = Darwin ]; then",
      "  podman machine list --format json | jq -r '.[].Running' | grep -q true || podman machine start > /dev/null 2>&1",
      "fi",

      "# --- PostgreSQL (one-time init + background start) ---",
      "mkdir -p .devbox/var/log",
      "if [ ! -d .devbox/var/lib/postgres/base ]; then initdb -D .devbox/var/lib/postgres; fi",
      "pg_ctl status -D .devbox/var/lib/postgres > /dev/null 2>&1 || pg_ctl -D .devbox/var/lib/postgres -l .devbox/var/log/postgres.log -o '-c unix_socket_directories=/tmp' -w start > /dev/null 2>&1 &",

      "# Silent dbt Fusion installation",
      "if ! command -v dbtf &> /dev/null; then",
      "  curl -fsSL https://public.cdn.getdbt.com/fs/install/install.sh | sh -s -- --update > /dev/null 2>&1 && echo 'dbt Fusion installed' || echo 'dbt Fusion install failed'",
      "fi"
    ]
  }
}
